FROM rockylinux:9-minimal

RUN microdnf install -y \
    coreutils-single \
    sed \
    grep \
    gzip \
    util-linux \
    procps-ng \
    findutils \
    wget \
    ca-certificates \
    tar \
    bash \
    && microdnf clean all

# Install bats and helpers from tarballs
RUN mkdir -p /opt/bats && \
    wget -qO- https://github.com/bats-core/bats-core/archive/refs/tags/v1.11.0.tar.gz | \
      tar xz -C /opt/bats --strip-components=1 && \
    /opt/bats/install.sh /usr/local && \
    mkdir -p /usr/local/lib/bats/bats-support && \
    wget -qO- https://github.com/bats-core/bats-support/archive/refs/tags/v0.3.0.tar.gz | \
      tar xz -C /usr/local/lib/bats/bats-support --strip-components=1 && \
    mkdir -p /usr/local/lib/bats/bats-assert && \
    wget -qO- https://github.com/bats-core/bats-assert/archive/refs/tags/v2.1.0.tar.gz | \
      tar xz -C /usr/local/lib/bats/bats-assert --strip-components=1

# Copy tlog_lib source and tests
COPY files/ /opt/tlog_lib/files/
COPY tests/ /opt/tlog_lib/tests/

WORKDIR /opt/tlog_lib/tests

CMD ["bats", "--formatter", "tap", "/opt/tlog_lib/tests/"]

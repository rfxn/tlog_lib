FROM centos:6

# CentOS 6 is EOL (Nov 2020) â€” use vault repos
RUN sed -i 's|^mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo && \
    sed -i 's|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo

RUN yum install -y \
    coreutils \
    sed \
    grep \
    gzip \
    util-linux-ng \
    procps \
    wget \
    ca-certificates \
    tar \
    bash \
    && yum clean all

# CentOS 6 wget may not support TLS 1.2+ for GitHub.
RUN mkdir -p /opt/bats && \
    (wget --no-check-certificate -qO- https://github.com/bats-core/bats-core/archive/refs/tags/v1.11.0.tar.gz || \
     curl -sSL -k https://github.com/bats-core/bats-core/archive/refs/tags/v1.11.0.tar.gz) | \
      tar xz -C /opt/bats --strip-components=1 && \
    /opt/bats/install.sh /usr/local && \
    mkdir -p /usr/local/lib/bats/bats-support && \
    (wget --no-check-certificate -qO- https://github.com/bats-core/bats-support/archive/refs/tags/v0.3.0.tar.gz || \
     curl -sSL -k https://github.com/bats-core/bats-support/archive/refs/tags/v0.3.0.tar.gz) | \
      tar xz -C /usr/local/lib/bats/bats-support --strip-components=1 && \
    mkdir -p /usr/local/lib/bats/bats-assert && \
    (wget --no-check-certificate -qO- https://github.com/bats-core/bats-assert/archive/refs/tags/v2.1.0.tar.gz || \
     curl -sSL -k https://github.com/bats-core/bats-assert/archive/refs/tags/v2.1.0.tar.gz) | \
      tar xz -C /usr/local/lib/bats/bats-assert --strip-components=1

# Copy tlog_lib source and tests
COPY files/ /opt/tlog_lib/files/
COPY tests/ /opt/tlog_lib/tests/

WORKDIR /opt/tlog_lib/tests

CMD ["bats", "--formatter", "tap", "/opt/tlog_lib/tests/"]
